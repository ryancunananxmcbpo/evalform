<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMC BPO Performance Appraisal</title>
    
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* XMC BPO Brand Identity */
            --brand-gradient: linear-gradient(90deg, #dc2626 0%, #ea580c 100%); /* Red to Orange */
            --brand-primary: #ea580c; /* Orange */
            --brand-secondary: #dc2626; /* Red */
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-surface: #f8fafc;
            --card-surface: #ffffff;
            --border: #e2e8f0;
            --success: #16a34a;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 10px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-surface);
            color: var(--text-dark);
            margin: 0;
            padding: 0 0 120px;
            line-height: 1.5;
        }

        /* --- BRANDED HEADER --- */
        .brand-header {
            background: var(--brand-gradient);
            color: white;
            padding: 35px 20px 80px; /* Extra padding bottom for overlap */
            text-align: center;
            position: relative;
        }
        
        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: 2.5rem;
            letter-spacing: -1px;
            margin: 0;
            text-transform: lowercase;
            line-height: 1;
        }
        .logo-text span { color: #fbbf24; /* Yellow/Gold "bpo" */ }
        
        .tagline {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.9rem;
            margin-top: 8px;
            opacity: 0.95;
        }

        .container {
            max-width: 1000px;
            margin: -50px auto 0; /* Overlap effect */
            padding: 0 20px;
            position: relative;
            z-index: 10;
        }

        /* --- CARDS & SECTIONS --- */
        .card {
            background: var(--card-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
            padding: 30px;
            margin-bottom: 25px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.15rem;
            color: var(--text-dark);
            margin: 0;
            display: flex; align-items: center; gap: 10px;
        }
        h2 i { color: var(--brand-primary); font-size: 1.1rem; }

        /* --- FORMS --- */
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
            background: #fff;
            transition: 0.2s;
            box-sizing: border-box;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }

        textarea { resize: vertical; min-height: 50px; }

        /* --- CHECKBOX PILLS --- */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-pill {
            display: flex; align-items: center; gap: 8px;
            background: #fff; border: 1px solid #cbd5e1;
            padding: 8px 16px; border-radius: 50px;
            font-size: 0.85rem; font-weight: 500; cursor: pointer;
            transition: 0.2s;
        }
        .checkbox-pill:hover { border-color: var(--brand-primary); background: #fff7ed; }
        .checkbox-pill input { width: auto; margin: 0; }

        /* --- TABLES --- */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            margin-top: 10px;
        }
        
        th {
            background: #fff7ed; /* Light orange tint */
            color: #9a3412;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #fed7aa;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
            background: #fff;
        }
        tr:last-child td { border-bottom: none; }

        /* Column Widths */
        .col-obj { width: 22%; }
        .col-ind { width: 22%; }
        .col-evi { width: 25%; }
        .col-wgt { width: 10%; }
        .col-rat { width: 10%; }
        .col-act { width: 11%; text-align: center; }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 6px;
            font-weight: 600; font-size: 0.85rem; border: none;
            cursor: pointer; transition: 0.2s;
        }
        .btn-add {
            background: #fff7ed; color: #ea580c;
            border: 1px solid #fed7aa;
        }
        .btn-add:hover { background: #ffedd5; }
        
        .btn-del {
            background: #fee2e2; color: #dc2626;
            padding: 6px 10px; font-size: 0.75rem;
            border-radius: 4px;
        }
        .btn-del:hover { background: #fecaca; }

        /* --- SCORES & SUMMARY --- */
        .summary-box {
            background: var(--text-dark);
            color: white; padding: 25px;
            border-radius: var(--radius);
        }
        .summary-box input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white; text-align: center; font-weight: 700; font-size: 1.2rem;
        }
        .summary-box label { color: #9ca3af; }

        /* --- FOOTER --- */
        .sticky-footer {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; gap: 15px; border: 1px solid #e2e8f0;
            z-index: 100;
        }
        .btn-print { background: white; border: 1px solid #cbd5e1; color: var(--text-dark); }
        .btn-submit { 
            background: var(--brand-gradient); 
            color: white; 
            padding: 10px 24px;
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.3);
        }

        /* --- SIGNATURES --- */
        .sig-box {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 15px; text-align: center;
        }
        canvas { width: 100%; height: 90px; }

        /* --- PRINT MODE (FORMAL DOC) --- */
        .page-break { display: none; }

        @media print {
            @page { size: A4; margin: 0.5cm; }
            body { 
                background: white; padding: 0; 
                zoom: 85%; /* Ensures perfect fit */
                -webkit-print-color-adjust: exact;
            }
            
            /* Clean Header for Print */
            .brand-header { padding: 15px; margin-bottom: 10px; }
            .logo-text { font-size: 1.8rem; }
            .container { margin: 0; max-width: 100%; }

            /* Remove Web Elements */
            .sticky-footer, .btn-add, .btn-del { display: none !important; }
            
            /* Formal Table Style */
            .card {
                box-shadow: none; border: 1px solid #000;
                padding: 15px; margin-bottom: 15px;
                break-inside: avoid;
            }
            .card-header { border-bottom: 1px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
            h2 { color: #000; font-size: 1.1rem; }
            h2 i { display: none; }

            /* Flatten Inputs */
            input, select, textarea {
                border: none; background: transparent; padding: 0;
                font-size: 9pt; min-height: auto;
            }
            
            table { border: 1px solid #000; font-size: 9pt; }
            th, td { border: 1px solid #000 !important; padding: 4px; }
            th { background-color: #eee !important; color: #000; }
            
            /* Hide Action Columns */
            .col-act, td:last-child, th:last-child { display: none; }
            
            /* Formal Page Break */
            .page-break { 
                display: block; 
                page-break-after: always; 
                height: 1px; 
            }
            #page2 { margin-top: 20px; }
        }
    </style>
</head>
<body>

<div class="brand-header">
    <h1 class="logo-text">xmc<span>bpo</span></h1>
    <div class="tagline">Together We Win</div>
</div>

<div class="container">
    <form id="appraisalForm">
        
        <div id="page1">
            
            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-regular fa-id-card"></i> A. Personal Details</h2>
                </div>
                <div class="grid-3">
                    <div><label>Employee Name</label><input type="text" name="employee_name" required></div>
                    <div><label>Position</label><input type="text" name="position" required></div>
                    <div><label>Department</label><input type="text" name="department" required></div>
                    <div><label>Supervised By</label><input type="text" name="supervised_by" required></div>
                    <div><label>Assessment Date</label><input type="text" class="date-picker" name="assessment_date" required></div>
                    <div><label>Period</label><input type="text" name="assessment_period" required></div>
                </div>
                <div class="grid-2" style="margin-top: 20px;">
                    <div><label>Employee Email</label><input type="email" name="employee_email" required></div>
                    <div><label>Supervisor Email</label><input type="email" name="supervisor_email" required></div>
                </div>
                
                <div style="margin-top: 20px; border-top:1px dashed #e2e8f0; padding-top:15px;">
                    <label style="margin-bottom:10px;">Assessment Type</label>
                    <div class="checkbox-group">
                        <label class="checkbox-pill"><input type="checkbox" name="assessment_type[]" value="Regularization"> Regularization</label>
                        <label class="checkbox-pill"><input type="checkbox" name="assessment_type[]" value="Mid-Year"> Mid-Year</label>
                        <label class="checkbox-pill"><input type="checkbox" name="assessment_type[]" value="Annual"> Annual</label>
                        <label class="checkbox-pill"><input type="checkbox" name="assessment_type[]" value="Confirmation"> Confirmation</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-chart-pie"></i> B. Performance Goals (60%)</h2>
                    <button type="button" class="btn btn-add" onclick="addKPIRow()"><i class="fa-solid fa-plus"></i> Add Goal</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th class="col-obj">Objective</th>
                            <th class="col-ind">Indicator</th>
                            <th class="col-evi">Evidence</th>
                            <th class="col-wgt">Weight %</th>
                            <th class="col-rat">Rating</th>
                            <th class="col-act">Action</th>
                        </tr>
                    </thead>
                    <tbody id="kpiBody">
                        </tbody>
                </table>
                <div style="text-align: right; margin-top: 15px; font-weight: 700; color: var(--brand-primary);">
                    Weighted Score: <span id="disp_goals_score">0.00</span>
                    <input type="hidden" name="performance_goals_average" id="performance_goals_average">
                </div>
            </div>

        </div> <div class="page-break"></div>

        <div id="page2">

            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-user-check"></i> C. Personal Effectiveness (40%)</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width:20%">Competency</th>
                            <th style="width:30%">Description</th>
                            <th style="width:40%">Remarks</th>
                            <th style="width:10%">Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td rowspan="3"><strong>PRODUCTIVITY</strong></td>
                            <td>Makes realistic goals; meets deadlines</td>
                            <td><textarea name="remarks_prod1" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_prod1" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td>Looks for efficiencies; works smarter</td>
                            <td><textarea name="remarks_prod2" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_prod2" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td>Delegates clearly</td>
                            <td><textarea name="remarks_prod3" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_prod3" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td rowspan="2"><strong>PERSONAL DEV</strong></td>
                            <td>Even-tempered under pressure</td>
                            <td><textarea name="remarks_dev1" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_dev1" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td>Sets high standards; sets challenging goals</td>
                            <td><textarea name="remarks_dev2" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_dev2" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td rowspan="3"><strong>LEADERSHIP</strong></td>
                            <td>Leads by example; finds realistic solutions</td>
                            <td><textarea name="remarks_lead1" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_lead1" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td>Establishes clear expectations; provides resources</td>
                            <td><textarea name="remarks_lead2" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_lead2" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td>Brings out the best in team members</td>
                            <td><textarea name="remarks_lead3" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_lead3" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td rowspan="2"><strong>RELATIONSHIP</strong></td>
                            <td>Strong customer advocate; sets aside bias</td>
                            <td><textarea name="remarks_rel1" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_rel1" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td>Gives practical advice; fosters loyalty</td>
                            <td><textarea name="remarks_rel2" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_rel2" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td rowspan="2"><strong>MANAGEMENT</strong></td>
                            <td>Prioritizes tasks; responds quickly to problems</td>
                            <td><textarea name="remarks_mgmt1" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_mgmt1" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                        <tr>
                            <td>Manages costs; develops strategy</td>
                            <td><textarea name="remarks_mgmt2" rows="1"></textarea></td>
                            <td><input type="number" class="eff-rating" name="rating_mgmt2" min="1" max="5" value="5" onchange="calcAll()"></td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 15px; font-weight: 700; color: var(--brand-primary);">
                    Effectiveness Score: <span id="disp_eff_score">0.00</span>
                    <input type="hidden" name="personal_effectiveness_average" id="personal_effectiveness_average">
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-list-check"></i> D. Action Plan</h2>
                    <button type="button" class="btn btn-add" onclick="addDevRow()"><i class="fa-solid fa-plus"></i> Add Item</button>
                </div>
                
                <div class="grid-2" style="margin-bottom: 20px;">
                    <div><label>Key Strengths</label><textarea name="strengths" rows="2"></textarea></div>
                    <div><label>Areas for Improvement</label><textarea name="areas_for_improvement" rows="2"></textarea></div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Improvement Area</th>
                            <th>Activity</th>
                            <th>Target Date</th>
                            <th>Success Criteria</th>
                            <th>Status</th>
                            <th class="col-act"></th>
                        </tr>
                    </thead>
                    <tbody id="devBody">
                        </tbody>
                </table>
            </div>

            <div class="grid-2">
                
                <div class="card summary-box">
                    <div class="card-header" style="border-bottom:1px solid rgba(255,255,255,0.2);">
                        <h2 style="color:white;"><i class="fa-solid fa-star" style="color:#fbbf24;"></i> E. Summary</h2>
                    </div>
                    <div class="grid-3" style="text-align:center;">
                        <div>
                            <label>Goals (60%)</label>
                            <input type="text" name="summary_goals" id="summary_goals" readonly>
                        </div>
                        <div>
                            <label>Effectiveness (40%)</label>
                            <input type="text" name="summary_effectiveness" id="summary_effectiveness" readonly>
                        </div>
                        <div>
                            <label style="color:white;">OVERALL</label>
                            <input type="text" name="summary_overall" id="summary_overall" readonly style="background:white; color:var(--brand-primary); box-shadow:0 4px 10px rgba(0,0,0,0.2);">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="fa-solid fa-signature"></i> F. Signatures</h2>
                    </div>
                    <div class="grid-3" style="gap:10px;">
                        <div class="sig-box">
                            <canvas id="sig_emp"></canvas>
                            <button type="button" class="btn btn-del" onclick="clearSig('sig_emp')" style="width:100%">Clear</button>
                            <input type="hidden" name="employee_signature_data" id="val_sig_emp">
                            <div style="font-size:0.7rem; margin-top:5px; font-weight:bold;">Employee</div>
                        </div>
                        <div class="sig-box">
                            <canvas id="sig_sup"></canvas>
                            <button type="button" class="btn btn-del" onclick="clearSig('sig_sup')" style="width:100%">Clear</button>
                            <input type="hidden" name="supervisor_signature_data" id="val_sig_sup">
                            <div style="font-size:0.7rem; margin-top:5px; font-weight:bold;">Supervisor</div>
                        </div>
                        <div class="sig-box">
                            <canvas id="sig_mgr"></canvas>
                            <button type="button" class="btn btn-del" onclick="clearSig('sig_mgr')" style="width:100%">Clear</button>
                            <input type="hidden" name="manager_signature_data" id="val_sig_mgr">
                            <div style="font-size:0.7rem; margin-top:5px; font-weight:bold;">Manager</div>
                        </div>
                    </div>
                    <div style="margin-top:15px;">
                        <label>Final Comments</label>
                        <textarea name="manager_comment" placeholder="Any final remarks..."></textarea>
                    </div>
                </div>
            </div>

        </div> <div class="sticky-footer">
            <button type="button" class="btn btn-print" onclick="window.print()">
                <i class="fa-solid fa-print"></i> Print (2-Page)
            </button>
            <button type="submit" class="btn btn-submit" id="btnSubmit">
                <i class="fa-solid fa-paper-plane"></i> Submit Appraisal
            </button>
        </div>

    </form>
</div>

<script>
    const FLOW_URL = "https://prod-55.southeastasia.logic.azure.com/workflows/d8cfce26ac5c40d3a55b96505f7e6467/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=tWqiYoH04h4DgSZpcyWdUSrDYgheEQ_r80lY4iaBH-s";

    flatpickr(".date-picker", { dateFormat: "Y-m-d" });

    // --- SIGNATURES ---
    const pads = {};
    ['sig_emp', 'sig_sup', 'sig_mgr'].forEach(id => {
        const canvas = document.getElementById(id);
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }
        window.addEventListener("resize", resizeCanvas);
        setTimeout(resizeCanvas, 200);
        pads[id] = new SignaturePad(canvas, { backgroundColor: 'rgba(255, 255, 255, 0)' });
    });
    window.clearSig = (id) => pads[id].clear();

    // --- KPI DEFAULTS (Full Detail) ---
    const defaultKPIs = [
        { obj: "CCTR", ind: "Actual CCTR/CCTR Goal", weight: 20 },
        { obj: "Partnership with other Dept.", ind: "Superior Assessment", weight: 20 },
        { obj: "Actual SPH/SPH Goal", ind: "Actual SPH/SPH Goal", weight: 20 },
        { obj: "Personal Attendance", ind: "Actual Hours/Hours Goal", weight: 20 },
        { obj: "Hours", ind: "Actual Hours/Hours Goal", weight: 20 }
    ];

    function addKPIRow(obj='', ind='', weight=20, rating=5) {
        const tbody = document.getElementById('kpiBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" name="kpi_objective[]" value="${obj}" placeholder="Objective" style="font-weight:600;"></td>
            <td><input type="text" name="kpi_indicator[]" value="${ind}" placeholder="Indicator"></td>
            <td><textarea name="kpi_evidence[]" placeholder="Evidence" rows="1"></textarea></td>
            <td><input type="number" name="kpi_weight[]" class="kpi-weight" value="${weight}" onchange="calcAll()"></td>
            <td><input type="number" name="kpi_rating[]" class="kpi-rating" min="1" max="5" step="0.5" value="${rating}" onchange="calcAll()"></td>
            <td class="col-act"><button type="button" class="btn btn-del" onclick="removeRow(this)"><i class="fa-solid fa-trash"></i></button></td>
        `;
        tbody.appendChild(row);
        calcAll();
    }

    // --- ACTION PLAN DEFAULTS ---
    function addDevRow() {
        const tbody = document.getElementById('devBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" name="dev_area[]" placeholder="Improvement Area"></td>
            <td><input type="text" name="dev_activity[]" placeholder="Activity"></td>
            <td><input type="text" class="date-picker-dyn" name="dev_date[]" placeholder="Target Date"></td>
            <td><input type="text" name="dev_criteria[]" placeholder="Success Criteria"></td>
            <td><input type="text" name="dev_status[]" placeholder="Status"></td>
            <td class="col-act"><button type="button" class="btn btn-del" onclick="removeRow(this)"><i class="fa-solid fa-trash"></i></button></td>
        `;
        tbody.appendChild(row);
        flatpickr(row.querySelector('.date-picker-dyn'), { dateFormat: "Y-m-d" });
    }

    window.removeRow = (btn) => {
        btn.closest('tr').remove();
        calcAll();
    }

    // Init Defaults
    defaultKPIs.forEach(k => addKPIRow(k.obj, k.ind, k.weight));
    addDevRow();
    addDevRow();

    // --- CALCULATIONS ---
    window.calcAll = () => {
        // Goals
        const weights = document.querySelectorAll('.kpi-weight');
        const ratings = document.querySelectorAll('.kpi-rating');
        let totalW = 0;
        let weightedSum = 0;

        weights.forEach((w, i) => {
            const wt = parseFloat(w.value) || 0;
            const rt = parseFloat(ratings[i].value) || 0;
            weightedSum += (wt * rt);
            totalW += wt;
        });
        
        const goalScore = totalW > 0 ? (weightedSum / totalW) : 0;
        document.getElementById('disp_goals_score').innerText = goalScore.toFixed(2);
        document.getElementById('performance_goals_average').value = goalScore.toFixed(2);
        document.getElementById('summary_goals').value = (goalScore * 0.6).toFixed(2);

        // Effectiveness
        const effs = document.querySelectorAll('.eff-rating');
        let effSum = 0;
        effs.forEach(e => effSum += (parseFloat(e.value) || 0));
        const effScore = effs.length > 0 ? (effSum / effs.length) : 0;

        document.getElementById('disp_eff_score').innerText = effScore.toFixed(2);
        document.getElementById('personal_effectiveness_average').value = effScore.toFixed(2);
        document.getElementById('summary_effectiveness').value = (effScore * 0.4).toFixed(2);

        // Overall
        const overall = (goalScore * 0.6) + (effScore * 0.4);
        document.getElementById('summary_overall').value = overall.toFixed(2);
    }

    // --- SUBMISSION ---
    document.getElementById('appraisalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');

        // Capture Signatures
        document.getElementById('val_sig_emp').value = pads['sig_emp'].isEmpty() ? '' : pads['sig_emp'].toDataURL();
        document.getElementById('val_sig_sup').value = pads['sig_sup'].isEmpty() ? '' : pads['sig_sup'].toDataURL();
        document.getElementById('val_sig_mgr').value = pads['sig_mgr'].isEmpty() ? '' : pads['sig_mgr'].toDataURL();

        const data = {};
        const inputs = document.querySelectorAll('input, textarea, select');
        
        inputs.forEach(el => {
            if(!el.name) return;
            if(el.type === 'radio' && !el.checked) return;
            if(el.type === 'checkbox') {
                if(el.checked) {
                    const cleanKey = el.name.replace('[]','');
                    if(!data[cleanKey]) data[cleanKey] = [];
                    data[cleanKey].push(el.value);
                }
            } else if (el.name.endsWith('[]')) {
                const cleanKey = el.name.slice(0, -2);
                if(!data[cleanKey]) data[cleanKey] = [];
                data[cleanKey].push(el.value);
            } else {
                data[el.name] = el.value;
            }
        });

        // UI Feedback
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

        try {
            const response = await fetch(FLOW_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert("✅ Success! Appraisal Data Synced.");
            } else {
                throw new Error("Status " + response.status);
            }
        } catch (error) {
            alert("❌ Connection Error: " + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
</script>

</body>
</html>
