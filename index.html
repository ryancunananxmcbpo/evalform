<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Performance Appraisal Form</title>
  <meta name="color-scheme" content="dark light">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    :root{
      --bg:#0f172a; --surface:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb;
      --primary:#ef4444; --primary2:#f97316; --border:#374151; --focus:#60a5fa;
      --shadow:0 10px 30px rgba(0,0,0,.35); --r:14px; --rs:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 700px at 110% -10%, rgba(249,115,22,.10), transparent 60%),
        radial-gradient(1200px 700px at 50% 120%, rgba(14,165,233,.08), transparent 60%),
        var(--bg);
    }
    .container{max-width:1100px;margin:32px auto 120px;padding:0 20px}
    .hero{
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:22px;margin:16px 0
    }
    .hero h1{margin:0 0 6px;font-size:26px}
    .card{background:rgba(31,41,55,.85);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:22px;margin:16px 0}
    .hint{color:var(--muted);font-size:13px;margin:6px 0 14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    label{display:flex;flex-direction:column;gap:6px;font-size:13px;color:#cbd5e1}
    input[type="text"],textarea,select{
      width:100%;padding:12px;background:#0b1220;color:var(--text);
      border:1px solid var(--border);border-radius:var(--rs);outline:none;
      transition:.15s border,.15s box-shadow,.15s transform
    }
    input:focus,textarea:focus,select:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(96,165,250,.25);transform:translateY(-1px)}
    textarea{min-height:90px;resize:vertical}
    .checkbox-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .checkbox-group label{flex-direction:row;align-items:center;gap:10px;background:#0b1220;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    thead th{background:#0b1220;color:#cbd5e1;padding:12px;text-align:left;border-bottom:1px solid var(--border);font-size:13px}
    tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top}
    tbody tr:nth-child(odd){background:rgba(2,6,23,.35)}
    tbody tr:nth-child(even){background:rgba(2,6,23,.15)}
    .weight{white-space:nowrap;font-weight:600;color:#eab308}
    .evidence-preview{display:block;margin-top:6px;color:#93c5fd;text-decoration:underline;font-size:13px}
    .signature-pad{border:1px dashed var(--border);background:#0b1220;width:100%;height:200px;border-radius:10px}
    .sig-actions{display:flex;gap:8px;margin-top:8px}
    .btn{appearance:none;border:none;cursor:pointer;padding:10px 16px;border-radius:12px;font-weight:600;color:#fff;box-shadow:var(--shadow)}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:#e5e7eb}
    .btn-ghost:hover{border-color:#9ca3af}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary2))}
    .btn-primary:hover{transform:translateY(-1px)}
    .sticky{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(2,6,23,0),rgba(2,6,23,.75) 30%,rgba(2,6,23,.9));backdrop-filter:blur(4px);padding:14px 0 18px;z-index:10}
    .sticky-inner{max-width:1100px;margin:0 auto;padding:0 20px;display:flex;gap:12px;justify-content:flex-end}
    .error{color:#fecaca;font-size:12px;margin-top:6px;display:none}
    .invalid input{border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.2)}
    .invalid .error{display:block}
    @media print{
      body{background:#fff;color:#000}
      .hero,.sticky,.btn{display:none!important}
      .card{border:1px solid #999;box-shadow:none}
      input,textarea,select{border:1px solid #999;color:#000;background:#fff}
      .evidence-preview{color:#000;text-decoration:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero">
      <h1>Performance Evaluation Form</h1>
      <p class="hint">Fill all sections. Scores auto-calculate. Print a copy after submitting.</p>
    </header>

    <form id="appraisalForm" novalidate>
      <!-- A. PERSONAL DETAILS -->
      <section class="card">
        <h2>A. PERSONAL DETAILS</h2>
        <div class="row">
          <label>Employee Name
            <input type="text" name="employee_name" required>
            <span class="error">Required.</span>
          </label>
          <label>Position
            <input type="text" name="position" required>
            <span class="error">Required.</span>
          </label>
          <label>Supervised By
            <input type="text" name="supervised_by" required>
            <span class="error">Required.</span>
          </label>
          <label>Department
            <input type="text" name="department" required>
            <span class="error">Required.</span>
          </label>
          <label>Assessment Date
            <input type="text" class="date-picker" name="assessment_date" required>
            <span class="error">Required.</span>
          </label>
          <label>Assessment Period
            <input type="text" name="assessment_period" required>
            <span class="error">Required.</span>
          </label>
        </div>

        <div class="row" style="margin-top:10px">
          <label>Employee Email
            <input type="text" name="employee_email" required>
            <span class="error">Enter a valid email.</span>
          </label>
          <label>Supervisor Email
            <input type="text" name="supervisor_email" required>
            <span class="error">Enter a valid email.</span>
          </label>
        </div>
      </section>

      <section class="card">
        <h2>Assessment Type</h2>
        <div class="checkbox-group">
          <label><input type="checkbox" name="assessment_type[]" value="Regularization"> Regularization</label>
          <label><input type="checkbox" name="assessment_type[]" value="Mid-Year"> Mid-Year</label>
          <label><input type="checkbox" name="assessment_type[]" value="Annual"> Annual</label>
          <label><input type="checkbox" name="assessment_type[]" value="Monthly"> Monthly</label>
          <label><input type="checkbox" name="assessment_type[]" value="Confirmation"> Confirmation</label>
        </div>
      </section>

      <!-- B. PERFORMANCE GOALS -->
      <section class="card">
        <h2>B. PERFORMANCE GOALS (100%)</h2>
        <div class="hint">5: Outstanding · 4: Exceeds some expectations · 3: Meets · 2: Meets some · 1: Does not meet</div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Objectives</th>
                <th>Indicators</th>
                <th>Evidence (URL or text)</th>
                <th>Weight</th>
                <th>Rating</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="text" name="objective_cctr" value="CCTR"></td>
                <td><input type="text" name="indicator_cctr" value="Actual CCTR/CCTR Goal"></td>
                <td>
                  <textarea name="evidence_cctr" oninput="updatePreview(this,'preview_cctr')"></textarea>
                  <a id="preview_cctr" class="evidence-preview" href="#" target="_blank" style="display:none">View Evidence</a>
                </td>
                <td class="weight">20%</td>
                <td>
                  <select name="rating_cctr" class="goal-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><input type="text" name="objective_partnership" value="Partnership with other Dept."></td>
                <td><input type="text" name="indicator_partnership" value="Superior Assessment"></td>
                <td>
                  <textarea name="evidence_partnership" oninput="updatePreview(this,'preview_partnership')"></textarea>
                  <a id="preview_partnership" class="evidence-preview" href="#" target="_blank" style="display:none">View Evidence</a>
                </td>
                <td class="weight">20%</td>
                <td>
                  <select name="rating_partnership" class="goal-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><input type="text" name="objective_sph" value="Actual SPH/SPH Goal"></td>
                <td><input type="text" name="indicator_sph" value="Actual SPH/SPH Goal"></td>
                <td>
                  <textarea name="evidence_sph" oninput="updatePreview(this,'preview_sph')"></textarea>
                  <a id="preview_sph" class="evidence-preview" href="#" target="_blank" style="display:none">View Evidence</a>
                </td>
                <td class="weight">20%</td>
                <td>
                  <select name="rating_sph" class="goal-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><input type="text" name="objective_attendance" value="Personal Attendance"></td>
                <td><input type="text" name="indicator_attendance" value="Actual Hours/Hours Goal"></td>
                <td>
                  <textarea name="evidence_attendance" oninput="updatePreview(this,'preview_attendance')"></textarea>
                  <a id="preview_attendance" class="evidence-preview" href="#" target="_blank" style="display:none">View Evidence</a>
                </td>
                <td class="weight">20%</td>
                <td>
                  <select name="rating_attendance" class="goal-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><input type="text" name="objective_hours" value="Hours"></td>
                <td><input type="text" name="indicator_hours" value="Actual Hours/Hours Goal"></td>
                <td>
                  <textarea name="evidence_hours" oninput="updatePreview(this,'preview_hours')"></textarea>
                  <a id="preview_hours" class="evidence-preview" href="#" target="_blank" style="display:none">View Evidence</a>
                </td>
                <td class="weight">20%</td>
                <td>
                  <select name="rating_hours" class="goal-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <label style="display:block;margin-top:10px">Performance Goals Average Score
          <input type="text" name="performance_goals_average" readonly>
        </label>
      </section>

      <!-- C. PERSONAL EFFECTIVENESS -->
      <section class="card">
        <h2>C. PERSONAL EFFECTIVENESS (100%)</h2>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Competency</th><th>Description</th><th>Remarks</th><th>Rating</th></tr></thead>
            <tbody>
              <tr>
                <td rowspan="3">PRODUCTIVITY</td>
                <td>Makes realistic goals meets deadline/complete tasks</td>
                <td><textarea name="remarks_productivity1"></textarea></td>
                <td>
                  <select name="rating_productivity1" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Looks for efficiencies; shows good judgement; works smarter</td>
                <td><textarea name="remarks_productivity2"></textarea></td>
                <td>
                  <select name="rating_productivity2" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Delegates clearly</td>
                <td><textarea name="remarks_productivity3"></textarea></td>
                <td>
                  <select name="rating_productivity3" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>

              <tr>
                <td rowspan="2">PERSONAL DEVELOPMENT</td>
                <td>Even-tempered under pressure</td>
                <td><textarea name="remarks_personal_dev1"></textarea></td>
                <td>
                  <select name="rating_personal_dev1" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Sets high standards; sets challenging goals</td>
                <td><textarea name="remarks_personal_dev2"></textarea></td>
                <td>
                  <select name="rating_personal_dev2" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>

              <tr>
                <td rowspan="3">LEADERSHIP</td>
                <td>Leads by example; finds realistic solutions; resolves conflicts</td>
                <td><textarea name="remarks_leadership1"></textarea></td>
                <td>
                  <select name="rating_leadership1" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Establishes clear expectations; provides resources; acts decisively</td>
                <td><textarea name="remarks_leadership2"></textarea></td>
                <td>
                  <select name="rating_leadership2" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Brings out the best in team members</td>
                <td><textarea name="remarks_leadership3"></textarea></td>
                <td>
                  <select name="rating_leadership3" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>

              <tr>
                <td rowspan="2">RELATIONSHIP</td>
                <td>Strong customer advocate; sets aside personal biases</td>
                <td><textarea name="remarks_relationship1"></textarea></td>
                <td>
                  <select name="rating_relationship1" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Gives practical advice; fosters loyalty</td>
                <td><textarea name="remarks_relationship2"></textarea></td>
                <td>
                  <select name="rating_relationship2" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>

              <tr>
                <td rowspan="2">MANAGEMENT</td>
                <td>Prioritizes tasks; responds quickly and well to problems</td>
                <td><textarea name="remarks_management1"></textarea></td>
                <td>
                  <select name="rating_management1" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Manages costs; develops strategy; organizes tasks</td>
                <td><textarea name="remarks_management2"></textarea></td>
                <td>
                  <select name="rating_management2" class="effect-rating">
                    <option value="5">5</option><option value="4.5">4.5</option><option value="4">4</option>
                    <option value="3.5">3.5</option><option value="3">3</option><option value="2.5">2.5</option>
                    <option value="2">2</option><option value="1.5">1.5</option><option value="1">1</option>
                  </select>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <label style="display:block;margin-top:10px">Personal Effectiveness Average Score
          <input type="text" name="personal_effectiveness_average" readonly>
        </label>
      </section>

      <section class="card">
        <h2>STRENGTHS</h2>
        <textarea name="strengths" rows="4"></textarea>
      </section>

      <section class="card">
        <h2>AREAS FOR IMPROVEMENT</h2>
        <textarea name="areas_for_improvement" rows="4"></textarea>
      </section>

      <section class="card">
        <h2>D. DEVELOPMENT PLAN</h2>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Improvement/Development Area</th><th>Development Activities</th><th>Target Date of Completion</th><th>Success Criteria</th><th>Status</th></tr></thead>
            <tbody>
              <tr>
                <td><input type="text" name="dev_area1"></td>
                <td><input type="text" name="dev_activities1"></td>
                <td><input type="text" class="date-picker" name="dev_target1"></td>
                <td><input type="text" name="dev_criteria1"></td>
                <td><input type="text" name="dev_status1"></td>
              </tr>
              <tr>
                <td><input type="text" name="dev_area2"></td>
                <td><input type="text" name="dev_activities2"></td>
                <td><input type="text" class="date-picker" name="dev_target2"></td>
                <td><input type="text" name="dev_criteria2"></td>
                <td><input type="text" name="dev_status2"></td>
              </tr>
              <tr>
                <td><input type="text" name="dev_area3"></td>
                <td><input type="text" name="dev_activities3"></td>
                <td><input type="text" class="date-picker" name="dev_target3"></td>
                <td><input type="text" name="dev_criteria3"></td>
                <td><input type="text" name="dev_status3"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2>E. PERFORMANCE SUMMARY RATINGS</h2>
        <div class="row">
          <label>Performance Goals (60%)
            <input type="text" name="summary_goals" readonly>
          </label>
          <label>Personal Effectiveness (40%)
            <input type="text" name="summary_effectiveness" readonly>
          </label>
        </div>
        <label style="display:block;margin-top:10px">Overall Score
          <input type="text" name="summary_overall" readonly>
        </label>
      </section>

      <!-- COMMENTS & SIGNATURES -->
      <section class="card">
        <h2>F. COMMENTS AND SIGNATURES</h2>
        <label>Evaluated Employee Comment
          <textarea name="employee_comment"></textarea>
        </label>

        <h3 style="margin:18px 0 8px">Evaluated Employee Signature</h3>
        <canvas id="employee_signature_pad" class="signature-pad"></canvas>
        <div class="sig-actions"><button type="button" class="btn btn-ghost" id="btnEmpClear">Clear</button></div>
        <input type="hidden" name="employee_signature_data" id="employee_signature_data">

        <label style="margin-top:18px">Immediate Supervisor Comment
          <textarea name="supervisor_comment"></textarea>
        </label>
        <h3 style="margin:18px 0 8px">Immediate Supervisor Signature</h3>
        <canvas id="supervisor_signature_pad" class="signature-pad"></canvas>
        <div class="sig-actions"><button type="button" class="btn btn-ghost" id="btnSupClear">Clear</button></div>
        <input type="hidden" name="supervisor_signature_data" id="supervisor_signature_data">

        <label style="margin-top:18px">Manager/Dept. Head Comment
          <textarea name="manager_comment"></textarea>
        </label>
        <h3 style="margin:18px 0 8px">Manager/Dept. Head Signature</h3>
        <canvas id="manager_signature_pad" class="signature-pad"></canvas>
        <div class="sig-actions"><button type="button" class="btn btn-ghost" id="btnMgrClear">Clear</button></div>
        <input type="hidden" name="manager_signature_data" id="manager_signature_data">
      </section>

      <!-- sticky actions -->
      <div class="sticky">
        <div class="sticky-inner">
          <button type="button" class="btn btn-ghost" onclick="window.print()">Print Form</button>
          <button type="submit" class="btn btn-primary" id="btnSubmit">Submit Form</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    // ====== FLOW URL ======
    const FLOW_CREATE_URL = "https://prod-55.southeastasia.logic.azure.com/workflows/d8cfce26ac5c40d3a55b96505f7e6467/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=tWqiYoH04h4DgSZpcyWdUSrDYgheEQ_r80lY4iaBH-s";

    // ====== Signature pads (white ink) ======
    const employeePad = new SignaturePad(document.getElementById('employee_signature_pad'), { penColor: '#fff' });
    const supervisorPad = new SignaturePad(document.getElementById('supervisor_signature_pad'), { penColor: '#fff' });
    const managerPad   = new SignaturePad(document.getElementById('manager_signature_pad'),   { penColor: '#fff' });

    document.getElementById('btnEmpClear').onclick = () => employeePad.clear();
    document.getElementById('btnSupClear').onclick = () => supervisorPad.clear();
    document.getElementById('btnMgrClear').onclick = () => managerPad.clear();

    function fitCanvas(c){
      const ratio = Math.max(window.devicePixelRatio||1,1);
      c.width = c.offsetWidth * ratio;
      c.height = c.offsetHeight * ratio;
      const ctx = c.getContext('2d');
      ctx.scale(ratio, ratio);
    }
    [employeePad, supervisorPad, managerPad].forEach(p => fitCanvas(p.canvas));
    window.addEventListener('resize', () => [employeePad, supervisorPad, managerPad].forEach(p => fitCanvas(p.canvas)));

    // ====== Date pickers (white/light theme for visibility) ======
    flatpickr(".date-picker", {
      dateFormat: "Y-m-d",
    });

    // ====== Derived fields ======
    const form = document.getElementById('appraisalForm');
    const submitBtn = document.getElementById('btnSubmit');

    function calculateAverages(){
      const goals = Array.from(document.querySelectorAll('.goal-rating')).map(s=>parseFloat(s.value||0));
      const goalsAvg = goals.length ? goals.reduce((a,b)=>a+b,0)/goals.length : 0;
      form.performance_goals_average.value = goalsAvg.toFixed(1);
      form.summary_goals.value = (goalsAvg*0.6).toFixed(1);

      const eff = Array.from(document.querySelectorAll('.effect-rating')).map(s=>parseFloat(s.value||0));
      const effAvg = eff.length ? eff.reduce((a,b)=>a+b,0)/eff.length : 0;
      form.personal_effectiveness_average.value = effAvg.toFixed(1);
      form.summary_effectiveness.value = (effAvg*0.4).toFixed(1);

      form.summary_overall.value = (goalsAvg*0.6 + effAvg*0.4).toFixed(1);
    }
    document.addEventListener('input', calculateAverages);
    document.addEventListener('DOMContentLoaded', calculateAverages);

    function updatePreview(textarea, id){
      const url = (textarea.value||'').trim();
      const a = document.getElementById(id);
      if(!a) return;
      if(/^https?:\/\//i.test(url)){ a.href = url; a.style.display='block'; }
      else { a.style.display='none'; }
    }
    window.updatePreview = updatePreview;

    const emailOk = e => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim());
    function markInvalid(name, state){
      const lab = form.querySelector(`[name="${name}"]`)?.closest('label');
      if(lab) lab.classList.toggle('invalid', !!state);
    }

    // ====== Submit handler ======
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      // simple validation
      const req = ['employee_name','position','supervised_by','department','assessment_date','assessment_period','employee_email','supervisor_email'];
      let firstInvalid = null;
      for(const f of req){
        const el = form.querySelector(`[name="${f}"]`);
        const val = (el?.value||'').trim();
        const bad = !val || ((f.endsWith('_email')) && !emailOk(val));
        markInvalid(f, bad);
        if(bad && !firstInvalid) firstInvalid = el;
      }
      if(firstInvalid){ firstInvalid.focus(); firstInvalid.scrollIntoView({behavior:'smooth',block:'center'}); return; }

      calculateAverages();

      // put signatures into hidden inputs (white ink already configured)
      document.getElementById('employee_signature_data').value = employeePad.isEmpty() ? '' : employeePad.toDataURL('image/png');
      document.getElementById('supervisor_signature_data').value = supervisorPad.isEmpty() ? '' : supervisorPad.toDataURL('image/png');
      document.getElementById('manager_signature_data').value   = managerPad.isEmpty()   ? '' : managerPad.toDataURL('image/png');

      // serialize form → JSON; merge checkbox array assessment_type[]
      const fd = new FormData(form);
      const data = {};
      fd.forEach((v,k)=>{
        if(k.endsWith('[]')){
          const key = k.slice(0,-2);
          (data[key]??=[]).push(v);
        }else{
          data[k]=v;
        }
      });

      // submit
      submitBtn.disabled = true; submitBtn.textContent = 'Submitting…';
      try{
        let res = await fetch(FLOW_CREATE_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });

        // fallback for some tenants/preflight quirks
        if(!res.ok && (res.status===401 || res.status===415 || res.status===0)){
          res = await fetch(FLOW_CREATE_URL, {
            method:'POST',
            headers:{'Content-Type':'text/plain'},
            body: JSON.stringify(data)
          });
        }

        if(!res.ok){
          if(res.status===401){
            alert('Submit failed (401). Your Flow URL must include the full key (contains &sig=...). Open the HTTP trigger in Flow and copy the full URL again.');
          }else{
            alert('Submit failed. Status: '+res.status);
          }
          return;
        }

        alert('Submitted successfully!');
        form.reset(); calculateAverages();
        employeePad.clear(); supervisorPad.clear(); managerPad.clear();
      }catch(err){
        console.error(err);
        alert('Network error while submitting. Please try again.');
      }finally{
        submitBtn.disabled = false; submitBtn.textContent = 'Submit Form';
      }
    });
  </script>
</body>
</html>